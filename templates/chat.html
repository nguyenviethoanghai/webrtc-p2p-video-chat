<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App - Optimized</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .chat-container {
            width: 90%;
            max-width: 1000px;
            height: 90vh;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            display: flex;
            overflow: hidden;
        }
        
        .sidebar {
            width: 300px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
        }
        
        .user-info {
            padding: 20px;
            background: #4285f4;
            color: white;
            text-align: center;
            position: relative;
        }
        
        .connection-status {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4caf50;
            animation: pulse 2s infinite;
        }
        
        .connection-status.disconnected {
            background: #f44336;
            animation: none;
        }
        
        .connection-status.reconnecting {
            background: #ff9800;
            animation: blink 1s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        
        .users-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .user-item {
            padding: 12px;
            margin: 5px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .user-item:hover {
            background: #e9ecef;
        }
        
        .user-item.active {
            background: #4285f4;
            color: white;
        }
        
        .user-status {
            display: flex;
            align-items: center;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-dot.online { background: #4caf50; }
        .status-dot.offline { background: #9e9e9e; }
        
        .unread-count {
            background: #f44336;
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 12px;
            min-width: 18px;
            text-align: center;
        }
        
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .message {
            margin: 10px 0;
            display: flex;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.own {
            justify-content: flex-end;
        }
        
        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
        }
        
        .message.own .message-content {
            background: #4285f4;
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .message:not(.own) .message-content {
            background: white;
            border: 1px solid #e9ecef;
            border-bottom-left-radius: 4px;
        }
        
        .message-status {
            font-size: 10px;
            margin-top: 4px;
            opacity: 0.7;
            text-align: right;
        }
        
        .message-status.sending { color: #ff9800; }
        .message-status.sent { color: #4caf50; }
        .message-status.delivered { color: #2196f3; }
        .message-status.read { color: #9c27b0; }
        .message-status.failed { color: #f44336; }
        
        .retry-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            margin-left: 8px;
        }
        
        .message-input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #e9ecef;
        }
        
        .input-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .message-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            outline: none;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .message-input:focus {
            border-color: #4285f4;
        }
        
        .send-btn, .file-btn, .call-btn {
            padding: 12px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .send-btn {
            background: #4285f4;
            color: white;
        }
        
        .file-btn {
            background: #34a853;
            color: white;
        }
        
        .call-btn {
            background: #ea4335;
            color: white;
        }
        
        .send-btn:hover, .file-btn:hover, .call-btn:hover {
            transform: scale(1.1);
        }
        
        .typing-indicator {
            padding: 10px 20px;
            font-style: italic;
            color: #666;
            font-size: 14px;
            display: none;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4285f4;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            display: none;
            z-index: 1000;
            animation: slideInRight 0.3s ease;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .notification.success { background: #4caf50; }
        .notification.error { background: #f44336; }
        .notification.warning { background: #ff9800; }
        
        .file-upload {
            display: none;
        }
        
        .file-preview {
            margin: 10px 0;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .file-preview img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
        }
        
        /* Video call modal */
        .video-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .video-container {
            position: relative;
            width: 80%;
            height: 80%;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .local-video, .remote-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .local-video {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 200px;
            height: 150px;
            border: 2px solid white;
            border-radius: 10px;
            z-index: 10;
        }
        
        .video-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
        }
        
        .video-btn {
            padding: 15px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            color: white;
            width: 60px;
            height: 60px;
        }
        
        .video-btn.mute { background: #ff9800; }
        .video-btn.video { background: #2196f3; }
        .video-btn.end { background: #f44336; }
        
        @media (max-width: 768px) {
            .chat-container {
                width: 100%;
                height: 100vh;
                border-radius: 0;
            }
            
            .sidebar {
                width: 100%;
                position: absolute;
                z-index: 100;
                transform: translateX(-100%);
                transition: transform 0.3s;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="sidebar">
            <div class="user-info">
                <div class="connection-status" id="connectionStatus"></div>
                <h3 id="currentUser">Loading...</h3>
                <p id="connectionText">Connecting...</p>
            </div>
            <div class="users-list" id="usersList">
                <!-- Users will be loaded here -->
            </div>
        </div>
        
        <div class="chat-area">
            <div class="chat-header">
                <div>
                    <h3 id="currentChatUser">Select a user to chat</h3>
                    <small id="chatUserStatus"></small>
                </div>
                <div>
                    <button class="call-btn" id="videoCallBtn" onclick="initiateVideoCall()" title="Video Call" disabled>üìπ</button>
                </div>
            </div>
            
            <div class="messages-container" id="messagesContainer">
                <!-- Messages will be loaded here -->
            </div>
            
            <div class="typing-indicator" id="typingIndicator">
                Someone is typing...
            </div>
            
            <div class="message-input-area">
                <div class="input-container">
                    <input type="file" class="file-upload" id="fileInput" accept="image/*,video/*,audio/*,.pdf,.doc,.docx">
                    <button class="file-btn" onclick="document.getElementById('fileInput').click()" title="Upload File">üìé</button>
                    <input type="text" class="message-input" id="messageInput" placeholder="Type your message..." maxlength="1000">
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()" title="Send Message">‚û§</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Video Call Modal -->
    <div class="video-modal" id="videoModal">
        <div class="video-container">
            <video class="remote-video" id="remoteVideo" autoplay></video>
            <video class="local-video" id="localVideo" autoplay muted></video>
            <div class="video-controls">
                <button class="video-btn mute" id="muteBtn" onclick="toggleAudio()">üé§</button>
                <button class="video-btn video" id="videoBtn" onclick="toggleVideo()">üì∑</button>
                <button class="video-btn end" id="endBtn" onclick="endCall()">üìû</button>
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
        // Global variables
        let socket;
        let currentUser = null;
        let selectedUserId = null;
        let unreadCounts = {};
        let messageQueue = [];
        let connectionRetries = 0;
        const maxRetries = 5;
        let isConnected = false;
        let lastMessageId = 0;
        let typingTimer;
        let isTyping = false;
        
        // Message status tracking
        let pendingMessages = new Map(); // client_message_id -> message data
        let messageRetryCount = new Map(); // client_message_id -> retry count
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const userData = localStorage.getItem('userData');
            if (!userData) {
                window.location.href = '/';
                return;
            }
            
            currentUser = JSON.parse(userData);
            document.getElementById('currentUser').textContent = currentUser.username;
            
            initializeSocket();
            loadUsers();
            
            // Setup message input
            const messageInput = document.getElementById('messageInput');
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
                
                // Typing indicator
                handleTyping();
            });
            
            // File upload
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
            
            // Auto-reconnect on visibility change
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden && !isConnected) {
                    attemptReconnection();
                }
            });
            
            // Heartbeat
            setInterval(sendHeartbeat, 30000);
        });
        
        function initializeSocket() {
            updateConnectionStatus('reconnecting', 'Connecting...');
            
            socket = io({
                transports: ['websocket', 'polling'],
                upgrade: true,
                rememberUpgrade: true,
                timeout: 20000,
                forceNew: true
            });
            
            // Connection events
            socket.on('connect', function() {
                console.log('Connected to server');
                isConnected = true;
                connectionRetries = 0;
                updateConnectionStatus('online', 'Connected');
                
                // Join room
                socket.emit('join', { user_id: currentUser.user_id });
                
                // Recover connection
                socket.emit('recover_connection', {
                    user_id: currentUser.user_id,
                    last_message_id: lastMessageId
                });
                
                // Process queued messages
                processMessageQueue();
                
                showNotification('Connected successfully!', 'success');
            });
            
            socket.on('disconnect', function() {
                console.log('Disconnected from server');
                isConnected = false;
                updateConnectionStatus('disconnected', 'Disconnected');
                showNotification('Connection lost. Attempting to reconnect...', 'warning');
                attemptReconnection();
            });
            
            socket.on('connect_error', function(error) {
                console.log('Connection error:', error);
                isConnected = false;
                updateConnectionStatus('disconnected', 'Connection failed');
                attemptReconnection();
            });
            
            // Message events
            socket.on('new_message', function(data) {
                addMessage(data);
                lastMessageId = Math.max(lastMessageId, data.id);
                
                // Update unread count
                if (data.sender_id !== currentUser.user_id && data.sender_id !== selectedUserId) {
                    unreadCounts[data.sender_id] = (unreadCounts[data.sender_id] || 0) + 1;
                    updateUsersList();
                }
                
                // Auto-scroll
                scrollToBottom();
                
                // Mark as read if chat is open
                if (data.sender_id === selectedUserId) {
                    markMessageAsRead(data.id);
                }
            });
            
            socket.on('message_received', function(data) {
                updateMessageStatus(data.client_message_id, 'sent');
            });
            
            socket.on('message_delivered', function(data) {
                updateMessageStatus(data.client_message_id, 'delivered');
                pendingMessages.delete(data.client_message_id);
            });
            
            socket.on('message_read_status', function(data) {
                updateMessageStatus(data.message_id, 'read');
            });
            
            socket.on('missed_messages', function(data) {
                data.messages.forEach(addMessage);
                scrollToBottom();
            });
            
            socket.on('user_status_changed', function(data) {
                updateUserStatus(data);
            });
            
            socket.on('error', function(data) {
                console.error('Socket error:', data);
                showNotification('Error: ' + data.message, 'error');
                
                if (data.client_message_id) {
                    updateMessageStatus(data.client_message_id, 'failed');
                }
            });
            
            // Heartbeat
            socket.on('pong', function() {
                console.log('Heartbeat received');
            });
        }
        
        function updateConnectionStatus(status, text) {
            const statusEl = document.getElementById('connectionStatus');
            const textEl = document.getElementById('connectionText');
            
            statusEl.className = `connection-status ${status}`;
            textEl.textContent = text;
        }
        
        function attemptReconnection() {
            if (connectionRetries >= maxRetries) {
                updateConnectionStatus('disconnected', 'Connection failed');
                showNotification('Failed to connect. Please refresh the page.', 'error');
                return;
            }
            
            connectionRetries++;
            updateConnectionStatus('reconnecting', `Reconnecting... (${connectionRetries}/${maxRetries})`);
            
            setTimeout(() => {
                if (!isConnected) {
                    socket.connect();
                }
            }, 2000 * connectionRetries);
        }
        
        function sendHeartbeat() {
            if (socket && isConnected) {
                socket.emit('ping');
            }
        }
        
        function processMessageQueue() {
            messageQueue.forEach(message => {
                socket.emit('send_message', message);
            });
            messageQueue = [];
        }
        
        function generateMessageId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if (!content || !selectedUserId) return;
            
            const clientMessageId = generateMessageId();
            const messageData = {
                sender_id: currentUser.user_id,
                receiver_id: selectedUserId,
                content: content,
                message_type: 'text',
                client_message_id: clientMessageId
            };
            
            // Add to UI immediately with pending status
            const tempMessage = {
                ...messageData,
                id: clientMessageId,
                sender_name: currentUser.username,
                created_at: new Date().toISOString()
            };
            addMessage(tempMessage, 'sending');
            
            // Store pending message
            pendingMessages.set(clientMessageId, messageData);
            messageRetryCount.set(clientMessageId, 0);
            
            // Send message
            if (isConnected) {
                socket.emit('send_message', messageData);
            } else {
                messageQueue.push(messageData);
                updateMessageStatus(clientMessageId, 'failed');
            }
            
            input.value = '';
        }
        
        function retryMessage(clientMessageId) {
            const messageData = pendingMessages.get(clientMessageId);
            if (!messageData) return;
            
            const retryCount = messageRetryCount.get(clientMessageId) || 0;
            if (retryCount >= 3) {
                showNotification('Message failed after 3 retries', 'error');
                return;
            }
            
            messageRetryCount.set(clientMessageId, retryCount + 1);
            updateMessageStatus(clientMessageId, 'sending');
            
            if (isConnected) {
                socket.emit('send_message', messageData);
            } else {
                updateMessageStatus(clientMessageId, 'failed');
            }
        }
        
        function updateMessageStatus(identifier, status) {
            const messageEl = document.querySelector(`[data-message-id="${identifier}"], [data-client-id="${identifier}"]`);
            if (!messageEl) return;
            
            const statusEl = messageEl.querySelector('.message-status');
            if (!statusEl) return;
            
            statusEl.className = `message-status ${status}`;
            
            switch(status) {
                case 'sending':
                    statusEl.innerHTML = '‚è≥ Sending...';
                    break;
                case 'sent':
                    statusEl.innerHTML = '‚úì Sent';
                    break;
                case 'delivered':
                    statusEl.innerHTML = '‚úì‚úì Delivered';
                    break;
                case 'read':
                    statusEl.innerHTML = '‚úì‚úì Read';
                    break;
                case 'failed':
                    const retryBtn = `<button class="retry-btn" onclick="retryMessage('${identifier}')">Retry</button>`;
                    statusEl.innerHTML = `‚ùå Failed ${retryBtn}`;
                    break;
            }
        }
        
        function addMessage(data, initialStatus = null) {
            const container = document.getElementById('messagesContainer');
            const isOwn = data.sender_id === currentUser.user_id;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isOwn ? 'own' : ''}`;
            messageDiv.setAttribute('data-message-id', data.id);
            if (data.client_message_id) {
                messageDiv.setAttribute('data-client-id', data.client_message_id);
            }
            
            let statusHtml = '';
            if (isOwn && initialStatus) {
                const statusText = {
                    'sending': '‚è≥ Sending...',
                    'sent': '‚úì Sent',
                    'delivered': '‚úì‚úì Delivered',
                    'read': '‚úì‚úì Read',
                    'failed': '‚ùå Failed'
                }[initialStatus];
                statusHtml = `<div class="message-status ${initialStatus}">${statusText}</div>`;
            }
            
            let contentHtml = '';
            if (data.message_type === 'file' && data.file_path) {
                const fileUrl = `/uploads/${data.file_path}`;
                const fileName = data.file_path.split('_').slice(1).join('_');
                
                if (data.file_path.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
                    contentHtml = `<img src="${fileUrl}" alt="${fileName}" style="max-width: 200px; border-radius: 8px;">`;
                } else {
                    contentHtml = `<a href="${fileUrl}" download="${fileName}" style="color: inherit;">${fileName}</a>`;
                }
            } else {
                contentHtml = escapeHtml(data.content);
            }
            
            messageDiv.innerHTML = `
                <div class="message-content">
                    ${!isOwn ? `<div style="font-size: 12px; margin-bottom: 5px; opacity: 0.7;">${data.sender_name}</div>` : ''}
                    <div>${contentHtml}</div>
                    <div style="font-size: 10px; margin-top: 5px; opacity: 0.7;">
                        ${new Date(data.created_at).toLocaleTimeString()}
                    </div>
                    ${statusHtml}
                </div>
            `;
            
            container.appendChild(messageDiv);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function markMessageAsRead(messageId) {
            if (socket && isConnected) {
                socket.emit('message_read', {
                    message_id: messageId,
                    user_id: currentUser.user_id
                });
            }
        }
        
        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            container.scrollTop = container.scrollHeight;
        }
        
        function loadUsers() {
            fetch('/api/users')
                .then(response => response.json())
                .then(users => {
                    updateUsersList(users);
                })
                .catch(error => {
                    console.error('Error loading users:', error);
                    showNotification('Failed to load users', 'error');
                });
        }
        
        function updateUsersList(users = null) {
            if (!users) return;
            
            const container = document.getElementById('usersList');
            container.innerHTML = '';
            
            users.forEach(user => {
                if (user.id === currentUser.user_id) return;
                
                const unreadCount = unreadCounts[user.id] || 0;
                const userDiv = document.createElement('div');
                userDiv.className = `user-item ${selectedUserId === user.id ? 'active' : ''}`;
                userDiv.onclick = () => selectUser(user.id, user.username);
                
                userDiv.innerHTML = `
                    <div class="user-status">
                        <div class="status-dot ${user.status}"></div>
                        <div>
                            <div style="font-weight: bold;">${user.username}</div>
                            <div style="font-size: 12px; opacity: 0.7;">
                                ${user.status === 'online' ? 'Online' : 'Last seen: ' + new Date(user.last_seen).toLocaleString()}
                            </div>
                        </div>
                    </div>
                    ${unreadCount > 0 ? `<div class="unread-count">${unreadCount}</div>` : ''}
                `;
                
                container.appendChild(userDiv);
            });
        }
        
        function selectUser(userId, username) {
            selectedUserId = userId;
            unreadCounts[userId] = 0;
            
            document.getElementById('currentChatUser').textContent = username;
            document.getElementById('videoCallBtn').disabled = false;
            
            // Update UI
            document.querySelectorAll('.user-item').forEach(item => item.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            // Load messages
            loadMessages(currentUser.user_id, userId);
            
            updateUsersList();
        }
        
        function loadMessages(user1Id, user2Id) {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';
            
            fetch(`/api/messages/${user1Id}/${user2Id}`)
                .then(response => response.json())
                .then(messages => {
                    messages.forEach(addMessage);
                    scrollToBottom();
                    
                    // Update last message ID
                    if (messages.length > 0) {
                        lastMessageId = Math.max(lastMessageId, ...messages.map(m => m.id));
                    }
                })
                .catch(error => {
                    console.error('Error loading messages:', error);
                    showNotification('Failed to load messages', 'error');
                });
        }
        
        function updateUserStatus(data) {
            const userItem = document.querySelector(`.user-item[onclick*="${data.user_id}"]`);
            if (userItem) {
                const statusDot = userItem.querySelector('.status-dot');
                statusDot.className = `status-dot ${data.status}`;
            }
        }
        
        function handleFileUpload() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file || !selectedUserId) return;
            
            if (file.size > 16 * 1024 * 1024) {
                showNotification('File too large. Maximum size is 16MB.', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            showNotification('Uploading file...', 'info');
            
            fetch('/api/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.file_path) {
                    const clientMessageId = generateMessageId();
                    const messageData = {
                        sender_id: currentUser.user_id,
                        receiver_id: selectedUserId,
                        content: file.name,
                        message_type: 'file',
                        file_path: data.file_path,
                        client_message_id: clientMessageId
                    };
                    
                    if (isConnected) {
                        socket.emit('send_message', messageData);
                    } else {
                        messageQueue.push(messageData);
                    }
                    
                    showNotification('File uploaded successfully!', 'success');
                } else {
                    showNotification('Upload failed: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Upload error:', error);
                showNotification('Upload failed', 'error');
            })
            .finally(() => {
                fileInput.value = '';
            });
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        function handleTyping() {
            if (!isTyping) {
                isTyping = true;
                // Implement typing indicator if needed
            }
            
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => {
                isTyping = false;
                // Stop typing indicator
            }, 1000);
        }
        
        // Video call functions (placeholder - implement with WebRTC)
        function initiateVideoCall() {
            if (!selectedUserId) return;
            
            showNotification('Video call feature coming soon!', 'info');
            // Implement WebRTC video call logic
        }
        
        function toggleAudio() {
            // Implement audio toggle
        }
        
        function toggleVideo() {
            // Implement video toggle
        }
        
        function endCall() {
            // Implement end call
            document.getElementById('videoModal').style.display = 'none';
        }
        
        // Logout
        function logout() {
            localStorage.removeItem('userData');
            if (socket) socket.disconnect();
            window.location.href = '/';
        }
    </script>
</body>
</html>
